<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003087">
    <title>Reserva Equipo Audiovisual</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://img.icons8.com/color/96/projector.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root { --azul: #003087; --verde: #28a745; --rojo: #dc3545; --gris: #f8f9fa; --amarillo: #ffc107; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--azul), #001f5b);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        .header h1 { font-size: 2.8em; margin-bottom: 10px; }
        .content { padding: 30px; }

        /* Estadísticas */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat {
            background: var(--gris);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border-bottom: 4px solid var(--azul);
        }
        .stat strong { display: block; font-size: 1.8em; color: var(--azul); }

        /* Formulario */
        .form-reserva {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 8px solid var(--azul);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .form-group label { font-weight: 600; color: var(--azul); display: block; margin-bottom: 5px; font-size: 0.9em;}
        .form-group select, .form-group input {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
        }

        /* Botones */
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-reservar { background: var(--verde); color: white; width: 100%; margin-top: 15px; }
        .btn-descargar { background: var(--azul); color: white; margin-bottom: 15px; }

        /* Grillas de Equipos */
        .section-title { color: var(--azul); font-size: 1.8em; margin: 40px 0 20px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .recursos-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 20px; 
        }

        .card { 
            background: white; border-radius: 12px; padding: 20px; border: 2px solid #eee; 
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card.ocupado { border-color: var(--verde); background: #f4fff4; }
        .card.disponible { border-color: var(--amarillo); background: #fffdf5; }
        
        .btn-liberar { background: var(--rojo); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; }

        /* Tabla */
        .reservas-lista { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: var(--azul); color: white; }

        .auto-reserva { background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; border: 3px solid #ffc107; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Gestión Audiovisual</h1>
        <p>Control Total de Recursos en Tiempo Real</p>
    </div>

    <div class="content">
        <div class="stats">
            <div class="stat"><strong id="proy-ocupados">0</strong>/8 Proyectores</div>
            <div class="stat"><strong id="ext-ocupadas">0</strong>/9 Exts</div>
            <div class="stat"><strong id="hdmi-ocupados">0</strong>/8 HDMI</div>
            <div class="stat"><strong id="bocinas-ocupadas">0</strong>/8 Bocinas</div>
            <div class="stat"><strong id="laptops-ocupadas">0</strong>/3 Laptops</div>
            <div class="stat"><strong id="microfono-ocupado">0</strong>/1 Mic</div>
        </div>

        <div id="auto-mensaje" class="auto-reserva" style="display:none;">
            <h2>¡Hola <span id="nombre-auto"></span>!</h2>
            <p>Se asignará: 1 Proyector + 1 Extensión + 1 HDMI disponibles.</p>
            <button class="btn btn-reservar" onclick="confirmarReservaAutomatica()">CONFIRMAR PRÉSTAMO RÁPIDO</button>
        </div>

        <div class="form-reserva">
            <h3 style="margin-bottom:15px; color:var(--azul)"><i class="fas fa-plus-circle"></i> Nueva Reserva Manual</h3>
            <div class="form-grid">
                <div class="form-group"><label>Docente</label><input type="text" id="docente" placeholder="Nombre..."></div>
                <div class="form-group"><label>Proyector</label><select id="proyector"></select></div>
                <div class="form-group"><label>Extensión</label><select id="extension"></select></div>
                <div class="form-group"><label>HDMI</label><select id="hdmi"></select></div>
                <div class="form-group"><label>Bocina</label><select id="bocina"></select></div>
                <div class="form-group"><label>Laptop</label><select id="laptop"></select></div>
                <div class="form-group"><label>Micrófono</label><select id="microfono"></select></div>
            </div>
            <button class="btn btn-reservar" onclick="reservarManual()">REGISTRAR EQUIPOS</button>
        </div>

        <h2 class="section-title">Préstamos Activos</h2>
        <input type="text" id="busqueda-reservas" placeholder="Buscar docente..." oninput="filtrarReservas()" style="padding:10px; width:100%; max-width:300px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;">
        <button class="btn btn-descargar" onclick="descargarJSON()"><i class="fas fa-download"></i> JSON</button>
        
        <div class="reservas-lista">
            <table id="tabla-reservas">
                <thead>
                    <tr><th>Docente</th><th>Equipos</th><th>Fecha/Hora</th><th>Acción</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h2 class="section-title">Estado de Proyectores</h2>
        <div class="recursos-grid" id="grid-proyectores"></div>

        <h2 class="section-title">Extensiones</h2>
        <div class="recursos-grid" id="grid-extensiones"></div>

        <h2 class="section-title">Cables HDMI</h2>
        <div class="recursos-grid" id="grid-hdmi"></div>

        <h2 class="section-title">Audio y Laptops</h2>
        <div class="recursos-grid" id="grid-otros"></div>

        <div style="margin-top:50px; padding:30px; background:#f8f9fa; border-radius:15px; text-align:center;">
            <h2 style="color:var(--azul)">Panel de Códigos QR</h2>
            <div id="qr-container" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-top:20px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';
    
    const app = initializeApp({ databaseURL: 'https://reservaproyectores-default-rtdb.firebaseio.com/' });
    const db = getDatabase(app);
    const reservasRef = ref(db, 'reservas');
    const docentesRef = ref(db, 'docentes');

    let reservas = {};
    let docenteQR = null;

    // --- LÓGICA DE INTERFAZ ---
    function actualizarEstadisticas() {
        const r = Object.values(reservas);
        document.getElementById('proy-ocupados').textContent = r.filter(x => x.proyector).length;
        document.getElementById('ext-ocupadas').textContent = r.filter(x => x.extension).length;
        document.getElementById('hdmi-ocupados').textContent = r.filter(x => x.hdmi).length;
        document.getElementById('bocinas-ocupadas').textContent = r.filter(x => x.bocina).length;
        document.getElementById('laptops-ocupadas').textContent = r.filter(x => x.laptop).length;
        document.getElementById('microfono-ocupado').textContent = r.filter(x => x.microfono).length;
    }

    function crearTarjeta(tipo, num, reserva = null) {
        const nombres = { proyector:`Proyector ${num}`, extension:`Extensión ${num}`, hdmi:`HDMI ${num}`, bocina:`Bocina ${num}`, laptop:`Laptop ${num}`, microfono:`Micrófono` };
        const idFull = reserva ? Object.keys(reservas).find(k => reservas[k] === reserva) : null;
        
        return `
            <div class="card ${reserva ? 'ocupado' : 'disponible'}">
                <div style="display:flex; justify-content:space-between;">
                    <strong>${nombres[tipo]}</strong>
                    <span style="font-size:0.8em; font-weight:bold;">${reserva ? 'USO' : 'LIBRE'}</span>
                </div>
                ${reserva ? `
                    <p style="margin:10px 0; font-weight:bold;">${reserva.docente}</p>
                    <button class="btn-liberar" onclick="liberarRecurso('${idFull}')">Liberar</button>
                ` : '<p style="color:#aaa; margin-top:10px;">Disponible</p>'}
            </div>`;
    }

    function mostrarRecursos() {
        const render = (id, tipo, max) => {
            let html = '';
            for(let i=1; i<=max; i++) {
                const r = Object.values(reservas).find(x => x[tipo] == i);
                html += crearTarjeta(tipo, i, r);
            }
            document.getElementById(id).innerHTML = html;
        };

        render('grid-proyectores', 'proyector', 8);
        render('grid-extensiones', 'extension', 9);
        render('grid-hdmi', 'hdmi', 8);
        
        // Render Otros (Bocinas, Laptops, Mic)
        let otrosHtml = '';
        for(let i=1; i<=8; i++) otrosHtml += crearTarjeta('bocina', i, Object.values(reservas).find(x => x.bocina == i));
        for(let i=1; i<=3; i++) otrosHtml += crearTarjeta('laptop', i, Object.values(reservas).find(x => x.laptop == i));
        otrosHtml += crearTarjeta('microfono', 1, Object.values(reservas).find(x => x.microfono));
        document.getElementById('grid-otros').innerHTML = otrosHtml;

        actualizarEstadisticas();
    }

    function actualizarSelects() {
        const p = (id, max, key) => {
            const s = document.getElementById(id);
            s.innerHTML = '<option value="">Ninguno</option>';
            for(let i=1; i<=max; i++) {
                if(!Object.values(reservas).some(r => r[key] == i)) s.innerHTML += `<option value="${i}">${i}</option>`;
            }
        };
        p('proyector', 8, 'proyector');
        p('extension', 9, 'extension');
        p('hdmi', 8, 'hdmi');
        p('bocina', 8, 'bocina');
        p('laptop', 3, 'laptop');
        const m = document.getElementById('microfono'); 
        m.innerHTML = '<option value="">No</option>';
        if(!Object.values(reservas).some(r => r.microfono)) m.innerHTML += '<option value="1">Sí</option>';
    }

    // --- ACCIONES ---
    window.reservarManual = async () => {
        const docente = document.getElementById('docente').value.trim();
        if(!docente) return alert("Nombre docente requerido");
        
        const data = {
            docente,
            proyector: document.getElementById('proyector').value || null,
            extension: document.getElementById('extension').value || null,
            hdmi: document.getElementById('hdmi').value || null,
            bocina: document.getElementById('bocina').value || null,
            laptop: document.getElementById('laptop').value || null,
            microfono: document.getElementById('microfono').value || null,
            fecha: new Date().toISOString()
        };

        await push(reservasRef, data);
        await set(ref(db, 'docentes/' + btoa(docente)), { nombre: docente });
        document.getElementById('docente').value = '';
    };

    window.liberarRecurso = async (id) => {
        if(confirm("¿Liberar estos equipos?")) await remove(ref(db, 'reservas/' + id));
    };

    window.confirmarReservaAutomatica = async () => {
        const p = Array.from({length:8},(_,i)=>i+1).find(n => !Object.values(reservas).some(r => r.proyector == n));
        const e = Array.from({length:9},(_,i)=>i+1).find(n => !Object.values(reservas).some(r => r.extension == n));
        const h = Array.from({length:8},(_,i)=>i+1).find(n => !Object.values(reservas).some(r => r.hdmi == n));
        
        if(!p || !e) return alert("No hay equipos suficientes para reserva automática");
        
        await push(reservasRef, {
            docente: docenteQR,
            proyector: p, extension: e, hdmi: h || null,
            fecha: new Date().toISOString()
        });
        location.href = location.pathname; // Limpiar URL
    };

    window.eliminarDocente = async (key) => {
        if(confirm("¿Eliminar este docente y su QR?")) await remove(ref(db, 'docentes/' + key));
    }

    window.filtrarReservas = () => {
        const busqueda = document.getElementById('busqueda-reservas').value.toLowerCase();
        mostrarReservas(busqueda);
    }

    function mostrarReservas(filtro = "") {
        const tbody = document.querySelector('#tabla-reservas tbody');
        tbody.innerHTML = '';
        Object.entries(reservas).forEach(([id, r]) => {
            if(filtro && !r.docente.toLowerCase().includes(filtro)) return;
            const items = [
                r.proyector && `P${r.proyector}`, r.extension && `E${r.extension}`, 
                r.hdmi && `H${r.hdmi}`, r.bocina && `B${r.bocina}`, 
                r.laptop && `L${r.laptop}`, r.microfono && `Mic`
            ].filter(Boolean).join(', ');
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>${r.docente}</strong></td>
                    <td>${items}</td>
                    <td style="font-size:0.8em">${new Date(r.fecha).toLocaleString()}</td>
                    <td><button onclick="liberarRecurso('${id}')" style="color:var(--rojo); border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>`;
        });
    }

    window.descargarJSON = () => {
        const blob = new Blob([JSON.stringify(reservas, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'reservas_audiovisual.json';
        a.click();
    };

    // --- SINCRONIZACIÓN ---
    onValue(reservasRef, (snap) => {
        reservas = snap.val() || {};
        mostrarRecursos();
        mostrarReservas();
        actualizarSelects();
    });

    onValue(docentesRef, (snap) => {
        const container = document.getElementById('qr-container');
        container.innerHTML = '';
        Object.entries(snap.val() || {}).forEach(([key, d]) => {
            const url = `${location.href.split('?')[0]}?qr=${encodeURIComponent(d.nombre)}`;
            container.innerHTML += `
                <div style="background:white; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ddd;">
                    <strong>${d.nombre}</strong><br>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}" style="margin:10px 0;">
                    <br><button onclick="eliminarDocente('${key}')" style="color:var(--rojo); border:none; background:none; cursor:pointer; font-size:0.8em;">Eliminar QR</button>
                </div>`;
        });
    });

    // Detectar QR en URL
    const params = new URLSearchParams(location.search);
    if(params.get('qr')) {
        docenteQR = decodeURIComponent(params.get('qr'));
        document.getElementById('nombre-auto').textContent = docenteQR;
        document.getElementById('auto-mensaje').style.display = 'block';
    }
</script>

</body>
</html>
